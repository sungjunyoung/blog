<!doctype html><html lang=en><head><title>Kubernetes 의 Ephemeral Storage 리소스 이해하기 ::
sungjunyoung</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Intro Kubernetes 는 실행 중인 컨테이너에서 사용할 리소스의 양을 지정할 수 있는 기능을 지원합니다.
리소스는 Pod 스펙 중 spec.containers[].resources.reequests 혹은 spec.containers[].resources.limits 로 지정이 가능합니다.
컨테이너에 대한 리소스 요청 (request) 을 지정하면 스케줄러가 이 리소스를 보고 해당 Pod 이 배치될 노드를 결정하며, 컨테이너에 대한 리소스 제한 (limit) 을 지정하면 실행 중인 컨테이너가 이 제한보다 많은 리소스를 사용할 수 없도록 제한하게 됩니다. 이 리소스 제한을 넘어가게 되면, Pod 이 Evict 되고 다른 노드로 넘어가는 등 운영 중에 생각지 못한 일이 발생할 수 있습니다."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://sungjunyoung.github.io/posts/what-is-ephemral-storage/><link rel=stylesheet href=https://sungjunyoung.github.io/assets/style.css><link rel=stylesheet href=https://sungjunyoung.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://sungjunyoung.github.io/assets/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://sungjunyoung.github.io/assets/img/favicon.png><link href=https://sungjunyoung.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://sungjunyoung.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://sungjunyoung.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://sungjunyoung.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://sungjunyoung.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://sungjunyoung.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="Kubernetes 의 Ephemeral Storage 리소스 이해하기"><meta name=twitter:description content="Intro Kubernetes 는 실행 중인 컨테이너에서 사용할 리소스의 양을 지정할 수 있는 기능을 지원합니다.
리소스는 Pod 스펙 중 spec.containers[].resources.reequests 혹은 spec.containers[].resources.limits 로 지정이 가능합니다.
컨테이너에 대한 리소스 요청 (request) 을 지정하면 스케줄러가 이 리소스를 보고 해당 Pod 이 배치될 노드를 결정하며, 컨테이너에 대한 리소스 제한 (limit) 을 지정하면 실행 중인 컨테이너가 이 제한보다 많은 리소스를 사용할 수 없도록 제한하게 됩니다. 이 리소스 제한을 넘어가게 되면, Pod 이 Evict 되고 다른 노드로 넘어가는 등 운영 중에 생각지 못한 일이 발생할 수 있습니다."><meta property="og:title" content="Kubernetes 의 Ephemeral Storage 리소스 이해하기"><meta property="og:description" content="Intro Kubernetes 는 실행 중인 컨테이너에서 사용할 리소스의 양을 지정할 수 있는 기능을 지원합니다.
리소스는 Pod 스펙 중 spec.containers[].resources.reequests 혹은 spec.containers[].resources.limits 로 지정이 가능합니다.
컨테이너에 대한 리소스 요청 (request) 을 지정하면 스케줄러가 이 리소스를 보고 해당 Pod 이 배치될 노드를 결정하며, 컨테이너에 대한 리소스 제한 (limit) 을 지정하면 실행 중인 컨테이너가 이 제한보다 많은 리소스를 사용할 수 없도록 제한하게 됩니다. 이 리소스 제한을 넘어가게 되면, Pod 이 Evict 되고 다른 노드로 넘어가는 등 운영 중에 생각지 못한 일이 발생할 수 있습니다."><meta property="og:type" content="article"><meta property="og:url" content="https://sungjunyoung.github.io/posts/what-is-ephemral-storage/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-29T19:30:48+09:00"><meta property="article:modified_time" content="2021-06-29T19:30:48+09:00"><meta property="og:site_name" content="sungjunyoung"><script async src="https://www.googletagmanager.com/gtag/js?id=G-CMFR9WZ898"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-CMFR9WZ898',{anonymize_ip:!1})}</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','G-CMFR9WZ898','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>sungjunyoung</span>
<span class=logo__cursor></span></a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>Kubernetes 의 Ephemeral Storage 리소스 이해하기</h1><div class=post-meta><span class=post-date>2021-06-29</span></div><span class=post-tags><a href=https://sungjunyoung.github.io/tags/kubernetes/>#kubernetes</a>&nbsp;</span><div class=post-content><h2>Table of Contents</h2><aside class=table-of-contents><nav id=TableOfContents><ul><li><a href=#intro>Intro</a></li><li><a href=#컨테이너의-ephemeral-storage-resources>컨테이너의 ephemeral storage resources</a><ul><li><a href=#rootfs>rootfs</a></li><li><a href=#container-log>container log</a></li></ul></li><li><a href=#kubernetes의-ephemeral-storage-resources>Kubernetes의 ephemeral storage resources</a><ul><li><a href=#hostpath>hostPath</a></li><li><a href=#emptydir>emptydir</a></li></ul></li><li><a href=#ephemeral-storage-를-어떻게-계산할까>Ephemeral Storage 를 어떻게 계산할까?</a><ul><li><a href=#emptydirlimiteviction>emptyDirLimitEviction</a></li><li><a href=#containerephemeralstoragelimiteviction>containerEphemeralStorageLimitEviction</a></li><li><a href=#podephemeralstoragelimiteviction>podEphemeralStorageLimitEviction</a></li></ul></li><li><a href=#pod-eviction-테스트>Pod Eviction 테스트</a><ul><li><a href=#emptydir-eviction>emptydir eviction</a></li><li><a href=#container-ephemeral-storage-limit-eviction>container ephemeral storage limit eviction</a></li><li><a href=#pod-ephemeral-storage-limit-eviction>pod ephemeral storage limit eviction</a></li></ul></li><li><a href=#마치며>마치며</a></li></ul></nav></aside><h2 id=intro>Intro</h2><p>Kubernetes 는 실행 중인 컨테이너에서 사용할 리소스의 양을 지정할 수 있는 기능을 지원합니다.<br>리소스는 Pod 스펙 중 <code>spec.containers[].resources.reequests</code> 혹은 <code>spec.containers[].resources.limits</code> 로 지정이 가능합니다.</p><p>컨테이너에 대한 리소스 요청 (request) 을 지정하면 스케줄러가 이 리소스를 보고 해당 Pod 이 배치될 노드를 결정하며,
컨테이너에 대한 리소스 제한 (limit) 을 지정하면 실행 중인 컨테이너가 이 제한보다 많은 리소스를 사용할 수 없도록 제한하게 됩니다.
이 리소스 제한을 넘어가게 되면, Pod 이 Evict 되고 다른 노드로 넘어가는 등 운영 중에 생각지 못한 일이 발생할 수 있습니다.</p><p>리소스는 다음과 같이 여러 타입이 있습니다.</p><ul><li>cpu</li><li>memory</li><li>ephemeral-storage</li></ul><p>위와 같은 리소스 외에도, 어드민이 확장 리소스를 정의하여 사용할 수 도 있습니다.</p><p>cpu 나 memory 의 경우 의미하는 바가 명확해 보이지만, <code>ephemeral-storage</code> 는 조금 생소해 보입니다.<br>이름만으로 유추해 보자면, ephemeral 은 &lsquo;임시&rsquo; 라는 뜻을 가지고 있으므로, 임시 저장소 정도의 느낌이 될것 같은데,<br>컨테이너 환경에서는 볼륨을 마운트 하지 않는 이상 데이터가 휘발성이 되기 때문에 이 임시 스토리지라는 이름은 조금 모호하게 느껴집니다.<br>특히 Kubernetes 환경으로 넘어가게 되면 Pod 내의 컨테이너리끼리 디렉토리를 공유하는 <code>Emptydir</code>, 컨테이너 생성 전 초기화 작업을 진행하는 <code>initContainers</code> 같은 스펙 등으로 임시 저장소로 쓸 수 있는 요소들이 많아져 더더욱 헷갈립니다. (저는 그랬습니다..)</p><h2 id=컨테이너의-ephemeral-storage-resources>컨테이너의 ephemeral storage resources</h2><p>먼저, 컨테이너에 국한해서 Ephemeral Storage, 즉 임시 저장소로 포함될 수 있는 것들에 대해서 체크해 볼까요?</p><h3 id=rootfs>rootfs</h3><p>컨테이너는 이미지 레이어 위에서 휘발성으로 동작합니다.<br>이 말은, 도커 이미지를 빌드할 때 명시되지 않은 디렉토리나 파일은 컨테이너가 내려가면 삭제된다는 뜻입니다.<br>아무리 컨테이너 위에서 파일을 쓰고 디렉토리를 만들어도 컨테이너가 내려가는 즉시 없어지는 휘발성 데이터이죠.</p><p>그럼 컨터이너에 접근하여 Write 되는 데이터들은 어디에 저장될까요?<br>Docker <a href=https://docs.docker.com/storage/storagedriver/select-storage-driver/>Storage Driver</a> 에 따라 저장되는 위치가 다르긴 하지만,<br>분명 호스트 어딘가에 저장될 것이고 컨테이너가 내려가지 않고 데이터가 쌓이게 되면 호스트에 영향을 줄 것이 분명합니다. (filesystem full 등)</p><blockquote><p>Docker storage driver 는 이 포스트에서는 다루지 않습니다.</p></blockquote><h3 id=container-log>container log</h3><p>컨테이너 내에서 포그라운드로 실행되는 프로세스는 stdout 으로 로그들을 내보내고, 이 로그들은 보통 <code>docker logs</code> 커맨드로 확인 할 수 있습니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ docker run -d --name hello hello-world
a77cb544c0867a4c9a36f9acb22abe64b3fd598579311a7516243962522e08da

$ docker logs hello
Hello from Docker!
This message shows that your installation appears to be working correctly.
...
</code></pre></div><p>container log 역시 호스트에 JSON 형태로 저장됩니다. 그리고 이 container log 가 많아지면 호스트에 영향을 줄 수 있습니다.<br>따라서 <code>container log</code> 역시 임시 저장소, <code>Ephemeral Storage</code> 에 포함됩니다.</p><h2 id=kubernetes의-ephemeral-storage-resources>Kubernetes의 ephemeral storage resources</h2><p><code>rootfs</code>, <code>container log</code> 두개로만 합산하여 Ephemeral Storage 사용량을 계산하면 참 간단하겠지만, Kubernetes 환경은 생각보다 만만치 않습니다. (?)<br>Ephemeral Storage 리소스에 제한을 두는 것은, 노드에 뜨는 컨테이너에 의해 영향받는 노드의 로컬 스토리지 가용량을 제어하려 하는 이유이고,
Kubernetes 에서는 Pod 에서 호스트의 로컬 스토리지를 사용할 수 있는 방법을 제공하고 있기 때문입니다.</p><h3 id=hostpath>hostPath</h3><p><code>hostPath</code> 볼륨은 <code>Docker</code> 에서 <code>--volume</code> 옵션을 사용하는 것과 같이 호스트에 존재하는 파일 혹은 디렉토리를 Pod 에 마운트하여 사용하는 방식입니다.<br>이 <code>hostPath</code> 볼륨은 클러스터 운용을 위한 어드민 데몬 외에 사용을 권장하고 있지 않습니다. 따라서 kube-system 혹은 다른 어드민 네임스페이스 외에는 보통 Pod Security Policy 를 통해 hostPath 볼륨의 사용을 제한합니다.<br>실제로도 운영 환경에서 일반적인 어플리케이션을 배포할 때 <code>hostPath</code> 를 사용하는 케이스는 찾기가 쉽지 않죠.<br>Kubernetes 에서도 이 <code>hostPath</code> 볼륨에 대해서는 따로 limit 을 걸고 있지 않습니다.</p><h3 id=emptydir>emptydir</h3><p>Kubernetes 에서는 Pod 안에 있는 Container 끼리 특정 디렉토리로 데이터를 공유할 수 있는 <code>emptydir</code> 이라는 스펙을 지원합니다.<br><code>emptydir</code> 을 포함한 Pod 이 생성되면, Kubelet 은 호스트에 빈 디렉토리를 생성하여 Pod 에 마운트 해줍니다.<br>Pod 이 내려가면 <code>emptydir</code> 내에 저장되어 있던 데이터도 사라지므로 임시 저장소라고 할 수 있습니다.<br>다만, <code>hostPath</code> 볼륨과는 다르게 클러스터 어드민 외에도 흔하게 쓸 수 있는 리소스이기 때문에 제한을 두는 것이 좋아 보입니다.</p><blockquote><p>이 포스트에서는 <code>emptyDir.medium "Memory"</code> 은 고려하지 않습니다.</p></blockquote><h2 id=ephemeral-storage-를-어떻게-계산할까>Ephemeral Storage 를 어떻게 계산할까?</h2><p>위에서 우리는 Ephemeral Storage 에 포함될 수 있는 리소스들을 Container / Kubernetes 환경별로 살펴 보았습니다.</p><p>정리해보면,</p><ul><li>rootfs</li><li>container log</li><li>emptydir</li></ul><p>위 세개의 리소스가 <code>ephermeral storage</code> 의 사용량에 영향을 미친다는 것을 알 수 있습니다.</p><blockquote><p>사실 GitRepo, ConfigMap 등 Kubernetes 환경에서는 영향을 미치는 리소스가 더 있습니다만, 생략합니다.</p></blockquote><p>그렇다면 <code>Kubernetes</code> 에서는 위 세 개의 리소스를 가지고 어떻게 ephemeral storage 사용량을 계산하고 Pod 을 Evict 시킬까요?</p><p>Kubernetes 소스에서 local storage 에 대한 eviction 을 체크하는 함수인 <code>localStorageEviction</code> 을 살펴봅시다.<br>이 함수는 주기적으로 실행되며, 클러스터 내에서 Local Storage Limit 을 초과한 Pod 을 Eviction 시켜줍니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// localStorageEviction checks the EmptyDir volume usage for each pod and determine whether it exceeds the specified limit and needs
</span><span style=color:#75715e>// to be evicted. It also checks every container in the pod, if the container overlay usage exceeds the limit, the pod will be evicted too.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>managerImpl</span>) <span style=color:#a6e22e>localStorageEviction</span>(<span style=color:#a6e22e>pods</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>, <span style=color:#a6e22e>statsFunc</span> <span style=color:#a6e22e>statsFunc</span>) []<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span> {
	<span style=color:#a6e22e>evicted</span> <span style=color:#f92672>:=</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>{}
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>pod</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>pods</span> {
		<span style=color:#a6e22e>podStats</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>statsFunc</span>(<span style=color:#a6e22e>pod</span>)
		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
			<span style=color:#66d9ef>continue</span>
		}

		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>emptyDirLimitEviction</span>(<span style=color:#a6e22e>podStats</span>, <span style=color:#a6e22e>pod</span>) {
			<span style=color:#a6e22e>evicted</span> = append(<span style=color:#a6e22e>evicted</span>, <span style=color:#a6e22e>pod</span>)
			<span style=color:#66d9ef>continue</span>
		}

		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>podEphemeralStorageLimitEviction</span>(<span style=color:#a6e22e>podStats</span>, <span style=color:#a6e22e>pod</span>) {
			<span style=color:#a6e22e>evicted</span> = append(<span style=color:#a6e22e>evicted</span>, <span style=color:#a6e22e>pod</span>)
			<span style=color:#66d9ef>continue</span>
		}

		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>containerEphemeralStorageLimitEviction</span>(<span style=color:#a6e22e>podStats</span>, <span style=color:#a6e22e>pod</span>) {
			<span style=color:#a6e22e>evicted</span> = append(<span style=color:#a6e22e>evicted</span>, <span style=color:#a6e22e>pod</span>)
		}
	}

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>evicted</span>
}

<span style=color:#75715e>// https://github.com/kubernetes/kubernetes/blob/af0b4c9031bd26aa5ce6b2ef4fc66cae14e183dc/pkg/kubelet/eviction/eviction_manager.go#L453
</span></code></pre></div><p>위 코드는 다음과 같이 동작합니다.</p><ol><li>인자로 넘어온 Pod 들을 순회하며</li><li>현재 Pod 이 Evict 되어야 하는지 판단 후 Evict 시키고, 배열에 append</li><li>Append 된 Pod 배열을 리턴</li></ol><p>현재 Pod 이 Evict 되어야 할지의 판단은 아래 세 종류로 판단합니다.</p><ul><li><code>emptyDirLimitEviction</code></li><li><code>podEphemeralStorageLimitEviction</code></li><li><code>containerEphemeralStorageLimitEviction</code></li></ul><h3 id=emptydirlimiteviction>emptyDirLimitEviction</h3><p>이 함수는 <code>emptyDir</code> 의 사용량을 보고 Eviction 여부를 판단합니다.<br>해당 Pod 이 <code>emptyDir</code> 이 있는지 체크하고, 있다면 현재 사용량과 Limit 을 비교합니다.</p><p>먼저 <code>emptydir</code> 은 <code>sizeLimit</code> 이라는 스펙을 가질 수 있는데요,<br>다음과 같이 사용됩니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>test</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>containers</span>:
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx</span>
      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>nginx</span>
      <span style=color:#f92672>volumeMounts</span>:
        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>emptydir</span>
          <span style=color:#f92672>mountPath</span>: <span style=color:#e6db74>&#34;/emptydir&#34;</span>
  <span style=color:#f92672>restartPolicy</span>: <span style=color:#ae81ff>Never</span>
  <span style=color:#f92672>volumes</span>:
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>test</span>
      <span style=color:#f92672>emptyDir</span>:
        <span style=color:#f92672>sizeLimit</span>: <span style=color:#e6db74>&#34;1Gi&#34;</span>
</code></pre></div><p>여기서 명시된 <code>sizeLimit</code> 을 Limit 으로 두고 사용량을 검사하게 됩니다.</p><p>만약 sizeLimit 을 명시하지 않는다면, Pod 의 ephemeral storage 사용량에 합산되며
이 수치를 넘어서면 <code>podEphemeralStorageLimitEviction</code> 에 따라 Pod 이 Evict 됩니다.</p><blockquote><p>Emptydir 이 앞서 주석으로 언급되었던 &ldquo;Memory&rdquo; 타입으로 사용되게 되면, memory 사용량으로 합산됩니다.</p></blockquote><h3 id=containerephemeralstoragelimiteviction>containerEphemeralStorageLimitEviction</h3><p>이 함수는 Pod 내 컨테이너들의 사용량을 측정하고, 해당 컨테이너의 제한보다 많이 사용하게 되면 Pod 을 Eviction 시킵니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>managerImpl</span>) <span style=color:#a6e22e>containerEphemeralStorageLimitEviction</span>(<span style=color:#a6e22e>podStats</span> <span style=color:#a6e22e>statsapi</span>.<span style=color:#a6e22e>PodStats</span>, <span style=color:#a6e22e>pod</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>) <span style=color:#66d9ef>bool</span> {
	<span style=color:#a6e22e>thresholdsMap</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>Quantity</span>)
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>container</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>Containers</span> {
		<span style=color:#a6e22e>ephemeralLimit</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>Resources</span>.<span style=color:#a6e22e>Limits</span>.<span style=color:#a6e22e>StorageEphemeral</span>()
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ephemeralLimit</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>ephemeralLimit</span>.<span style=color:#a6e22e>Value</span>() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
			<span style=color:#a6e22e>thresholdsMap</span>[<span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>Name</span>] = <span style=color:#a6e22e>ephemeralLimit</span>
		}
	}

	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>containerStat</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>podStats</span>.<span style=color:#a6e22e>Containers</span> {
		<span style=color:#a6e22e>containerUsed</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>diskUsage</span>(<span style=color:#a6e22e>containerStat</span>.<span style=color:#a6e22e>Logs</span>)
		<span style=color:#66d9ef>if</span> !<span style=color:#f92672>*</span><span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>dedicatedImageFs</span> {
			<span style=color:#a6e22e>containerUsed</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>diskUsage</span>(<span style=color:#a6e22e>containerStat</span>.<span style=color:#a6e22e>Rootfs</span>))
		}

		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ephemeralStorageThreshold</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>thresholdsMap</span>[<span style=color:#a6e22e>containerStat</span>.<span style=color:#a6e22e>Name</span>]; <span style=color:#a6e22e>ok</span> {
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ephemeralStorageThreshold</span>.<span style=color:#a6e22e>Cmp</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>containerUsed</span>) &lt; <span style=color:#ae81ff>0</span> {
				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>evictPod</span>(<span style=color:#a6e22e>pod</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#a6e22e>containerEphemeralStorageMessageFmt</span>, <span style=color:#a6e22e>containerStat</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#a6e22e>ephemeralStorageThreshold</span>.<span style=color:#a6e22e>String</span>()), <span style=color:#66d9ef>nil</span>) {
					<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>Evictions</span>.<span style=color:#a6e22e>WithLabelValues</span>(<span style=color:#a6e22e>signalEphemeralContainerFsLimit</span>).<span style=color:#a6e22e>Inc</span>()
					<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
				}
				<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
			}
		}
	}
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
}
<span style=color:#75715e>// https://github.com/kubernetes/kubernetes/blob/af0b4c9031bd26aa5ce6b2ef4fc66cae14e183dc/pkg/kubelet/eviction/eviction_manager.go#L527
</span></code></pre></div><p>소스코드에서 위에서 알아보았던 container log 와 rootfs 를 합산하는 모습이 보이네요. (<code>diskUsage(containerStat.Logs)</code>, <code>diskUsage(containerStat.Rootfs)</code>)</p><h3 id=podephemeralstoragelimiteviction>podEphemeralStorageLimitEviction</h3><p><code>podEphemeralStorageLimitEviction</code> 은 하나의 Pod 에 대한 Ephemeral Storage 사용량을 측정하고,
Pod Limit 이상으로 사용되고 있다면 해당 Pod 을 Eviction 시킵니다.</p><p>위에서 Container Spec 으로 리소스의 Limit / Request 을 결정할 수 있었는데요,
아래 yaml 과 같이 Pod 에는 리소스를 제한할 수 있는 스펙이 없습니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>frontend</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>containers</span>:
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>app</span>
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>images.my-company.example/app:v4</span>
    <span style=color:#f92672>resources</span>:
      <span style=color:#f92672>requests</span>:
        <span style=color:#f92672>ephemeral-storage</span>: <span style=color:#e6db74>&#34;2Gi&#34;</span>
      <span style=color:#f92672>limits</span>:
        <span style=color:#f92672>ephemeral-storage</span>: <span style=color:#e6db74>&#34;4Gi&#34;</span>
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>log-aggregator</span>
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>images.my-company.example/log-aggregator:v6</span>
    <span style=color:#f92672>resources</span>:
      <span style=color:#f92672>requests</span>:
        <span style=color:#f92672>ephemeral-storage</span>: <span style=color:#e6db74>&#34;2Gi&#34;</span>
      <span style=color:#f92672>limits</span>:
        <span style=color:#f92672>ephemeral-storage</span>: <span style=color:#e6db74>&#34;4Gi&#34;</span>
</code></pre></div><p>그렇다면 Pod 의 Ephemeral Storage 제한은 어떻게 결정될까요?
간단하게 생각하면 Pod 스펙 내 컨테이너의 Ephemeral Storage 제한을 모두 더한 값으로 결정할 수 있을 것 같지만,
Pod 스펙에는 <code>initContainers</code> 라는 초기화 컨테이너 스펙이 추가될 수 있다는 점을 생각하면 또 헷갈리기 시작합니다.</p><blockquote><p>제가 이 포스트를 써보기로 한 이유이기도 합니다.</p></blockquote><p>Pod 의 Resource 제한이 어떻게 계산되는지 알아보기 위해 코드를 살펴보도록 하겠습니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>managerImpl</span>) <span style=color:#a6e22e>podEphemeralStorageLimitEviction</span>(<span style=color:#a6e22e>podStats</span> <span style=color:#a6e22e>statsapi</span>.<span style=color:#a6e22e>PodStats</span>, <span style=color:#a6e22e>pod</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>) <span style=color:#66d9ef>bool</span> {
	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>podLimits</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>apiv1resource</span>.<span style=color:#a6e22e>PodRequestsAndLimits</span>(<span style=color:#a6e22e>pod</span>)
    <span style=color:#f92672>...</span>
}
<span style=color:#75715e>// https://github.com/kubernetes/kubernetes/blob/af0b4c9031bd26aa5ce6b2ef4fc66cae14e183dc/pkg/kubelet/eviction/eviction_manager.go#L503
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>PodRequestsAndLimitsReuse</span>(<span style=color:#a6e22e>pod</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>, <span style=color:#a6e22e>reuseReqs</span>, <span style=color:#a6e22e>reuseLimits</span> <span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>ResourceList</span>) (<span style=color:#a6e22e>reqs</span>, <span style=color:#a6e22e>limits</span> <span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>ResourceList</span>) {
	<span style=color:#75715e>// attempt to reuse the maps if passed, or allocate otherwise
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>reqs</span>, <span style=color:#a6e22e>limits</span> = <span style=color:#a6e22e>reuseOrClearResourceList</span>(<span style=color:#a6e22e>reuseReqs</span>), <span style=color:#a6e22e>reuseOrClearResourceList</span>(<span style=color:#a6e22e>reuseLimits</span>)

	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>container</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>Containers</span> {
		<span style=color:#a6e22e>addResourceList</span>(<span style=color:#a6e22e>reqs</span>, <span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>Resources</span>.<span style=color:#a6e22e>Requests</span>)
		<span style=color:#a6e22e>addResourceList</span>(<span style=color:#a6e22e>limits</span>, <span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>Resources</span>.<span style=color:#a6e22e>Limits</span>)
	}
	<span style=color:#75715e>// init containers define the minimum of any resource
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>container</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>InitContainers</span> {
		<span style=color:#a6e22e>maxResourceList</span>(<span style=color:#a6e22e>reqs</span>, <span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>Resources</span>.<span style=color:#a6e22e>Requests</span>)
		<span style=color:#a6e22e>maxResourceList</span>(<span style=color:#a6e22e>limits</span>, <span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>Resources</span>.<span style=color:#a6e22e>Limits</span>)
	}
    
	<span style=color:#75715e>// if PodOverhead feature is supported, add overhead for running a pod
</span><span style=color:#75715e></span>	<span style=color:#75715e>// to the sum of requests and to non-zero limits:
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>Overhead</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>utilfeature</span>.<span style=color:#a6e22e>DefaultFeatureGate</span>.<span style=color:#a6e22e>Enabled</span>(<span style=color:#a6e22e>features</span>.<span style=color:#a6e22e>PodOverhead</span>) {
    <span style=color:#f92672>...</span>
}

<span style=color:#75715e>// https://github.com/kubernetes/kubernetes/blob/264496cc4166d841a4c278fe096d6dd29e8f836a/pkg/api/v1/resource/helpers.go#L44
</span></code></pre></div><p><code>podEphemeralStorageLimitEviction</code> 함수에서 Pod Limit 을 가져오기 위해 <code>PodRequestsAndLimits</code> 함수를 호출합니다.
<code>PodRequestsAndLimits</code> 함수는 <code>PodRequestsAndLimitsReuse</code> 를 호출하고, 이 함수는 다음과 같은 절차로 Pod 의 리소스 제한을 계산하게 됩니다.</p><ol><li><code>Pod.Spec.Containers</code> 스펙 내의 컨테이너들을 순회하며 Requests, Limits 들을 결과에 합산</li><li><code>Pod.Spec.InitContainers</code> 스펙 내의 컨테이너들을 순회하며 이 Requests, Limits 값이 <code>1.</code> 에서 합산된 값보다 크면 대체</li></ol><p>정리하자면, Pod 의 리소스 제한은 다음과 같이 결정됩니다.</p><p>max(<code>Pod.Spec.Containers 컨테이너들의 리소스 Limit 합</code>, <code>Pod.Spec.InitContainers 컨테이너 각각의 리소스 Limit</code>)</p><blockquote><p>Spec.Overhead 스펙은 해당 포스트에서 생략합니다.</p></blockquote><p>Pod Ephemeral Storage 의 Limit 을 계산하는 방법은 알아 냈습니다. 그렇다면 Pod 의 Ephemeral Storage 사용량은 어떻게 측정될까요?
<code>containerEphemeralStorageLimitEviction</code> 와는 다르게, <code>podEphemeralStorageLimitEviction</code> 은 local ephemeral volume 을 포함해 ephemeral storage 사용량을 측정합니다. local ephemeral volume 은 host 의 스토리지 영역을 사용하는 볼륨을 뜻하며, local ephemeral volume 의 여부는 아래와 같이 판단됩니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// IsLocalEphemeralVolume determines whether the argument is a local ephemeral
</span><span style=color:#75715e>// volume vs. some other type
</span><span style=color:#75715e>// Local means the volume is using storage from the local disk that is managed by kubelet.
</span><span style=color:#75715e>// Ephemeral means the lifecycle of the volume is the same as the Pod.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>IsLocalEphemeralVolume</span>(<span style=color:#a6e22e>volume</span> <span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Volume</span>) <span style=color:#66d9ef>bool</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>volume</span>.<span style=color:#a6e22e>GitRepo</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span>
		(<span style=color:#a6e22e>volume</span>.<span style=color:#a6e22e>EmptyDir</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>volume</span>.<span style=color:#a6e22e>EmptyDir</span>.<span style=color:#a6e22e>Medium</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>StorageMediumDefault</span>) <span style=color:#f92672>||</span>
		<span style=color:#a6e22e>volume</span>.<span style=color:#a6e22e>ConfigMap</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span>
}
<span style=color:#75715e>// https://github.com/kubernetes/kubernetes/blob/fe7a862c2d14bf6f9aff92f11338ede0d3e1a9a1/pkg/volume/util/util.go#L588
</span></code></pre></div><ul><li>GitRepo</li><li>Emptydir Medium 이 Default("") 인 Emptydir</li><li>ConfigMap</li></ul><p>위 세개의 리소스가 Local Ephemeral Volume 사용량에 합산되어 계산됩니다.</p><h2 id=pod-eviction-테스트>Pod Eviction 테스트</h2><p>이제 우리는 Kubernetes 에서 Ephemeral Storage Limit 을 어떻게 계산하는지까지 알아보았습니다.<br>분석한 내용대로 Pod 이 Eviction 되는지 테스트해 보겠습니다.</p><h3 id=emptydir-eviction>emptydir eviction</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>emptydir-eviction</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>securityContext</span>:
    <span style=color:#f92672>runAsUser</span>: <span style=color:#ae81ff>0</span>
  <span style=color:#f92672>containers</span>:
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx</span>
      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>nginx:1.14.2</span>
      <span style=color:#f92672>volumeMounts</span>:
        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>emptydir</span>
          <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/emptydir</span>
  <span style=color:#f92672>volumes</span>:
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>emptydir</span>
      <span style=color:#f92672>emptyDir</span>:
        <span style=color:#f92672>sizeLimit</span>: <span style=color:#ae81ff>1Gi</span>
</code></pre></div><p>Emptydir Eviction 을 테스트 하기 위해 위와 같은 스펙으로 Pod 을 생성했습니다.</p><ul><li>emptydir 볼륨을 <code>sizeLimit: 1Gi</code> 로 추가</li><li>해당 볼륨을 컨테이너 내 <code>/emptydir</code> 디렉토리에 마운트</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ k exec -it emptydir-eviction bash
<span style=color:#f92672>[</span>root@emptydir-eviction nginx-1.14.2<span style=color:#f92672>]</span><span style=color:#75715e># cd /emptydir/</span>
<span style=color:#f92672>[</span>root@emptydir-eviction emptydir<span style=color:#f92672>]</span><span style=color:#75715e># for i in {1..3}; do echo $i; dd if=/dev/zero of=$i bs=1MB count=500; sleep 20; done</span>
<span style=color:#ae81ff>1</span>
500+0 records in
500+0 records out
<span style=color:#ae81ff>500000000</span> bytes <span style=color:#f92672>(</span><span style=color:#ae81ff>500</span> MB<span style=color:#f92672>)</span> copied, 0.274682 s, 1.8 GB/s
<span style=color:#ae81ff>2</span>
500+0 records in
500+0 records out
<span style=color:#ae81ff>500000000</span> bytes <span style=color:#f92672>(</span><span style=color:#ae81ff>500</span> MB<span style=color:#f92672>)</span> copied, 0.269753 s, 1.9 GB/s
<span style=color:#ae81ff>3</span>
500+0 records in
500+0 records out
<span style=color:#ae81ff>500000000</span> bytes <span style=color:#f92672>(</span><span style=color:#ae81ff>500</span> MB<span style=color:#f92672>)</span> copied, 0.257411 s, 1.9 GB/s
<span style=color:#f92672>[</span>root@emptydir-eviction emptydir<span style=color:#f92672>]</span><span style=color:#75715e># command terminated with exit code 137</span>
</code></pre></div><p>컨테이너에 접근하여 수동으로 <code>/emptydir</code> 디렉토리에 데이터를 넣어 보겠습니다.
실행한 스크립트는 500MB 파일을 디렉토리에 20초 간격으로 3번 Write 하게 됩니다.</p><pre><code>Warning  Evicted    2s     kubelet, xxxxxx  Usage of EmptyDir volume &quot;emptydir&quot; exceeds the limit &quot;1Gi&quot;.
</code></pre><p>Write 가 끝난 후 <code>/emptydir</code> 디렉토리에는 1.5GB 의 파일이 쌓여 있을 것이고, 이는 우리가 설정한 emptydir sizeLimit 인 1Gi 보다 크기 때문에
위와 같은 로그를 남기며 Pod 이 Evict 되는 모습을 보실 수 있습니다.</p><blockquote><p>Evict 시점은 Kubelet 의 사용량 확인 시점에 따라 다를 수 있습니다.</p></blockquote><h3 id=container-ephemeral-storage-limit-eviction>container ephemeral storage limit eviction</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>container-ephemeral-storage-eviction</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>securityContext</span>:
    <span style=color:#f92672>runAsUser</span>: <span style=color:#ae81ff>0</span>
  <span style=color:#f92672>containers</span>:
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx</span>
      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>nginx:1.14.2</span>
      <span style=color:#f92672>resources</span>:
        <span style=color:#f92672>limits</span>:
          <span style=color:#f92672>ephemeral-storage</span>: <span style=color:#ae81ff>500Mi</span>
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>app</span>
      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>busybox</span>
      <span style=color:#f92672>resources</span>:
        <span style=color:#f92672>limits</span>:
          <span style=color:#f92672>ephemeral-storage</span>: <span style=color:#ae81ff>500Mi</span>
</code></pre></div><p>다음은 container ephemeral storage limit 스펙에 따른 eviction 을 테스트 해보기 위해서 위와 같은 스펙으로 Pod 을 띄워 보겠습니다.
컨테이너 스펙으로 각각 <code>ephemeral-storage</code> 제한을 <code>500Mi</code> 로 설정하고, 두개의 컨테이너를 띄웁니다.</p><p>이렇게 되면 각각의 컨테이너의 리소스 제한은 500Mi 가 되고, Pod Ephemeral Storage 제한은 두 컨테이너 (nginx, app) 제한의 합인 1Gi 가 됩니다.
이 중 한 컨테이너에 접근해서 1.5GB 파일을 Write 해봅니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ k exec -it container-ephemeral-storage-eviction -c nginx bash
<span style=color:#f92672>[</span>root@container-ephemeral-storage-eviction nginx-1.14.2<span style=color:#f92672>]</span><span style=color:#75715e># for i in {1..3}; do echo $i; dd if=/dev/zero of=$i bs=1MB count=500; sleep 20; done</span>
<span style=color:#ae81ff>1</span>
500+0 records in
500+0 records out
<span style=color:#ae81ff>500000000</span> bytes <span style=color:#f92672>(</span><span style=color:#ae81ff>500</span> MB<span style=color:#f92672>)</span> copied, 0.271112 s, 1.8 GB/s
<span style=color:#ae81ff>2</span>
500+0 records in
500+0 records out
<span style=color:#ae81ff>500000000</span> bytes <span style=color:#f92672>(</span><span style=color:#ae81ff>500</span> MB<span style=color:#f92672>)</span> copied, 0.261845 s, 1.9 GB/s
<span style=color:#ae81ff>3</span>
500+0 records in
500+0 records out
<span style=color:#ae81ff>500000000</span> bytes <span style=color:#f92672>(</span><span style=color:#ae81ff>500</span> MB<span style=color:#f92672>)</span> copied, 0.280843 s, 1.8 GB/s
command terminated with exit code <span style=color:#ae81ff>137</span>
</code></pre></div><pre><code>Warning  Evicted    15s   kubelet, xxxxxx  Container nginx exceeded its local ephemeral storage limit &quot;500Mi&quot;.
</code></pre><p>pod describe 를 통해 확인해보면, container ephemeral storage limit 에러로 Evict 되었다는 것을 확인할 수 있습니다.
컨테이너 Ephemeral Storage 제한인 500Mi 에 걸려 Evict 되었다는 것을 알 수 있네요.</p><h3 id=pod-ephemeral-storage-limit-eviction>pod ephemeral storage limit eviction</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pod-ephemeral-storage-eviction</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>securityContext</span>:
    <span style=color:#f92672>runAsUser</span>: <span style=color:#ae81ff>0</span>
  <span style=color:#f92672>initContainers</span>:
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>centos</span>
      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>centos:7</span>
      <span style=color:#f92672>command</span>: [<span style=color:#e6db74>&#39;sh&#39;</span>, <span style=color:#e6db74>&#39;-c&#39;</span>, <span style=color:#e6db74>&#39;sleep 10&#39;</span>]
      <span style=color:#f92672>resources</span>:
        <span style=color:#f92672>limits</span>:
          <span style=color:#f92672>ephemeral-storage</span>: <span style=color:#ae81ff>2Gi</span>
  <span style=color:#f92672>containers</span>:
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx</span>
      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>nginx:1.14.2</span>
      <span style=color:#f92672>resources</span>:
        <span style=color:#f92672>limits</span>:
          <span style=color:#f92672>ephemeral-storage</span>: <span style=color:#ae81ff>500Mi</span>
      <span style=color:#f92672>volumeMounts</span>:
        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>emptydir</span>
          <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/emptydir</span>
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>app</span>
      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>busybox</span>
      <span style=color:#f92672>resources</span>:
        <span style=color:#f92672>limits</span>:
          <span style=color:#f92672>ephemeral-storage</span>: <span style=color:#ae81ff>500Mi</span>
      <span style=color:#f92672>volumeMounts</span>:
        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>emptydir</span>
          <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/emptydir</span>
  <span style=color:#f92672>volumes</span>:
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>emptydir</span>
      <span style=color:#f92672>emptyDir</span>: {}
</code></pre></div><p>마지막으로, Pod 에 대한 ephemeral storage limit eviction 을 테스트 해보겠습니다.<br>위와 같은 스펙으로 Pod 을 작성 시, Pod Limit 은 어떻게 될까요?</p><p>max(<code>Pod.Spec.Containers 컨테이너들의 리소스 Limit 합</code>, <code>Pod.Spec.InitContainers 컨테이너 각각의 리소스 Limit</code>)</p><p>containers 내의 리소스 Limit 합은 1Gi (500Mi + 500Mi) 이지만 initContainers 에 있는 centos 컨테이너의 Limit 이 2Gi 이므로
더 큰 2Gi 가 Pod 의 리소스 제한이 됩니다.
그리고 각 컨테이너들은 <code>/emptydir</code> 위치에 <code>sizeLimit</code> 이 없는 emptydir 을 마운트합니다.
pod limit 사용량에는 default type emptydir 사용량이 합산되므로, emptydir 이 마운트된 위치에 파일을 Write 해보면서 테스트 해볼 수 있을 것 같습니다.</p><p>아래와 같이 두 케이스로 두고 테스트를 진행해 보겠습니다.</p><ol><li>Pod 리소스 제한(2Gi)을 넘지 않도록 <code>/emptydir</code> 경로에 Write (1.5GB)</li><li>Pod 리소스 제한(2Gi)을 넘도록 <code>/emptydir</code> 경로에 Write (2.5GB)</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ k exec -it pod-ephemeral-storage-eviction -c nginx bash
<span style=color:#f92672>[</span>root@pod-ephemeral-storage-eviction nginx-1.14.2<span style=color:#f92672>]</span><span style=color:#75715e># cd /emptydir/</span>
<span style=color:#f92672>[</span>root@pod-ephemeral-storage-eviction emptydir<span style=color:#f92672>]</span><span style=color:#75715e># for i in {1..3}; do echo $i; dd if=/dev/zero of=$i bs=1MB count=500; sleep 20; done</span>
<span style=color:#ae81ff>1</span>
500+0 records in
500+0 records out
<span style=color:#ae81ff>500000000</span> bytes <span style=color:#f92672>(</span><span style=color:#ae81ff>500</span> MB<span style=color:#f92672>)</span> copied, 0.271969 s, 1.8 GB/s
<span style=color:#ae81ff>2</span>
500+0 records in
500+0 records out
<span style=color:#ae81ff>500000000</span> bytes <span style=color:#f92672>(</span><span style=color:#ae81ff>500</span> MB<span style=color:#f92672>)</span> copied, 0.271598 s, 1.8 GB/s
<span style=color:#ae81ff>3</span>
500+0 records in
500+0 records out
<span style=color:#ae81ff>500000000</span> bytes <span style=color:#f92672>(</span><span style=color:#ae81ff>500</span> MB<span style=color:#f92672>)</span> copied, 0.262356 s, 1.9 GB/s
</code></pre></div><p>1.5GB 파일을 <code>/emptydir</code> 경로에 Write 시 Pod Evict 가 일어나지 않았습니다. Pod Limit 제한이 2Gi 이기 때문이죠.
이제 500MB 파일을 두개 더 생성하여 emptydir 사용량이 2.5GB 가 되도록 해보겠습니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>root@pod-ephemeral-storage-eviction emptydir<span style=color:#f92672>]</span><span style=color:#75715e># for i in {4..5}; do echo $i; dd if=/dev/zero of=$i bs=1MB count=500; sleep 20; done</span>
<span style=color:#ae81ff>4</span>
500+0 records in
500+0 records out
<span style=color:#ae81ff>500000000</span> bytes <span style=color:#f92672>(</span><span style=color:#ae81ff>500</span> MB<span style=color:#f92672>)</span> copied, 0.266805 s, 1.9 GB/s
<span style=color:#ae81ff>5</span>
500+0 records in
500+0 records out
<span style=color:#ae81ff>500000000</span> bytes <span style=color:#f92672>(</span><span style=color:#ae81ff>500</span> MB<span style=color:#f92672>)</span> copied, 0.266405 s, 1.9 GB/s
<span style=color:#f92672>[</span>root@pod-ephemeral-storage-eviction emptydir<span style=color:#f92672>]</span><span style=color:#75715e># command terminated with exit code 137</span>
</code></pre></div><p>예상했던대로 Pod Limit 인 2Gi 를 넘어서니 (2.5GB) Evict 가 되었습니다.</p><pre><code>Warning  Evicted    69s    kubelet, xxxxxx  Pod ephemeral local storage usage exceeds the total limit of containers 2Gi.
</code></pre><p>로그 상으로도 initContainers 의 최대 Limit 인 2Gi 로 Limit 이 결정된 것을 확인할 수 있습니다.</p><h2 id=마치며>마치며</h2><p>이 포스트는 Container Ephemeral Limit 을 설정했는데, Evict 된 Pod Description 로그에는 Limit 이 예상한 대로 나오지 않는다는 사용자 제보로 조사하다가, 좀 더 알아보고 싶은 생각에 작성하게 되었습니다.</p><p><code>코드 안에 답이 있다</code>라는 말이 실감나는 좋은 경험이었던 것 같습니다.</p><p>Ephemeral Storage 리소스에 대해 좀 더 알아보고 싶었던 분들에게 도움이 되었으면 합니다.</p></div><br><script>function updateUtterancTheme(){const a=window.localStorage&&window.localStorage.getItem("theme"),b={type:'set-theme',theme:a==="dark"?"photon-dark":"github-light"};var c=document.querySelector('iframe');c.contentWindow.postMessage(b,'https://utteranc.es')}window.addEventListener("storage",updateUtterancTheme),window.addEventListener('message',a=>{if(a.origin!=='https://utteranc.es')return;updateUtterancTheme()})</script><script src=https://utteranc.es/client.js repo=sungjunyoung/sungjunyoung.github.io issue-term=pathname label=💬 theme=photon-dark crossorigin=anonymous async></script></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>sungjunyoung</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2022 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://sungjunyoung.github.io/assets/main.js></script><script src=https://sungjunyoung.github.io/assets/prism.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-CMFR9WZ898"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-CMFR9WZ898',{anonymize_ip:!1})}</script></body></html>